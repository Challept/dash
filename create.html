<!DOCTYPE html>
<html lang="sv" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Webstay Butikswizard</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Custom Animations -->
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.5s ease-out;
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-200">
  <!-- Custom Alert Container -->
  <div id="alertMessage" class="fixed top-4 right-4 z-50 p-4 rounded-lg hidden"></div>

  <!-- Login Section -->
  <div id="loginSection" class="min-h-screen flex items-center justify-center">
    <div class="bg-gray-800 shadow-lg rounded-lg p-8 max-w-md w-full">
      <h2 class="text-2xl font-bold mb-4 text-center">
        Logga in för att starta din butikswizard
      </h2>
      <div id="g_id_onload"
           data-client_id="216513476074-2g3ua2sboin4g8f16n8mdf9o2h1tbn0q.apps.googleusercontent.com"
           data-callback="handleCredentialResponse"
           data-auto_prompt="true"></div>
      <div class="g_id_signin" data-type="standard"></div>
    </div>
  </div>

  <!-- Butikswizard Section (hidden until login) -->
  <div id="wizard" class="hidden min-h-screen p-4">
    <div class="max-w-3xl mx-auto bg-gray-800 shadow-xl rounded-lg overflow-hidden animate-fadeIn">
      <header class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6 text-center">
        <h1 class="text-3xl font-bold">Skapa Din Butik</h1>
      </header>
      <div class="p-6">
         <!-- Action Section: Create store form or Upgrade plan -->
         <div id="storeAction" class="mb-6"></div>
         <!-- Store List Section -->
         <h2 class="text-2xl font-semibold mb-4">Mina Butiker</h2>
         <ul id="storeList" class="space-y-4"></ul>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    let currentUser = null;
    // Simulated store limit – non-upgraded users may bara skapa 1 butik
    let maxStoresAllowed = 1;

    // Custom alert function with dark theme styling and fade-out effect
    function showAlert(message, type="error") {
      const alertDiv = document.getElementById("alertMessage");
      let bgClass = type === "error" ? "bg-red-600 border-red-800" : "bg-green-600 border-green-800";
      alertDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-lg border ${bgClass} text-white`;
      alertDiv.textContent = message;
      alertDiv.classList.remove("hidden");
      setTimeout(() => {
        alertDiv.classList.add("hidden");
      }, 4000);
    }

    // Hjälpfunktion: Avkoda JWT-token
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(c => {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        console.error("Fel vid avkodning av token:", e);
        return null;
      }
    }

    // Google Sign-In callback – vid lyckad inloggning
    function handleCredentialResponse(response) {
      console.log("Mottog Google-inloggningsuppgifter.");
      const payload = parseJwt(response.credential);
      if (payload) {
        currentUser = payload;
        console.log("Inloggad som:", payload.email);
        // Dölj login-sektionen och visa wizard
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("wizard").classList.remove("hidden");
        fetchStores();
        renderStoreAction();
      } else {
        showAlert("Kunde inte avkoda Google-token.", "error");
      }
    }

    // Rendera åtgärdssektionen – skapa butik eller uppgradera plan
    function renderStoreAction() {
      const storeActionDiv = document.getElementById("storeAction");
      fetch("https://api.webstay.se/get-users")
        .then(res => res.json())
        .then(allStores => {
          const userStores = allStores.filter(store => store.UserID === currentUser.sub && store.StoreID.trim() !== "");
          storeActionDiv.innerHTML = "";
          if (userStores.length < maxStoresAllowed) {
            // Visa formulär för att skapa butik
            storeActionDiv.innerHTML = `
              <h2 class="text-xl font-semibold mb-2">Steg 1: Ange Butiksnamn</h2>
              <form id="createStoreForm" class="flex flex-col gap-4">
                <input type="text" id="storeName" placeholder="Ange butiksnamn" required 
                  class="p-3 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-blue-500 text-white">
                <button type="submit" 
                  class="bg-blue-600 text-white py-3 rounded hover:bg-blue-500 transition transform hover:scale-105">
                  Skapa butik
                </button>
              </form>
            `;
            document.getElementById("createStoreForm")
              .addEventListener("submit", createStore);
          } else {
            // Visa knapp för att uppgradera plan
            storeActionDiv.innerHTML = `
              <button id="upgradePlanBtn" class="w-full bg-yellow-500 text-white py-3 rounded hover:bg-yellow-600 transition transform hover:scale-105">
                Uppgradera plan
              </button>
            `;
            document.getElementById("upgradePlanBtn")
              .addEventListener("click", () => {
                window.location.href = "https://order.webstay.se/upgrade";
              });
          }
        })
        .catch(err => {
          console.error("Fel vid hämtning av butiker:", err);
          showAlert("Fel vid hämtning av butiker.", "error");
        });
    }

    // Hantera skapande av butik
    async function createStore(e) {
      e.preventDefault();
      const storeName = document.getElementById("storeName").value.trim();
      if (!storeName) {
        showAlert("Ange ett giltigt butiksnamn.", "error");
        return;
      }
      console.log("Initierar skapande av butik:", storeName);
      try {
        // Steg 1: Tilldela ett unikt Store ID
        const assignRes = await fetch("https://api.webstay.se/assign-store-id", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: currentUser.sub })
        });
        const assignData = await assignRes.json();
        if (!assignRes.ok || !assignData.success) {
          throw new Error(assignData.error || "Misslyckades med att tilldela Store ID");
        }
        const storeId = assignData.storeId;
        console.log("Tilldelat Store ID:", storeId);

        // Steg 2: Skapa butiken och initiera Stripe-onboarding
        const createRes = await fetch("https://api.webstay.se/create-store", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            store_id: storeId,
            store_name: storeName,
            email: currentUser.email
          })
        });
        const createData = await createRes.json();
        if (!createRes.ok) {
          throw new Error(createData.error || "Misslyckades med att skapa butik");
        }
        console.log("Butik skapad:", storeName);
        if (createData.onboarding_url) {
          window.open(createData.onboarding_url, "_blank");
          console.log("Onboarding-länk öppnad:", createData.onboarding_url);
        }
        document.getElementById("storeName").value = "";
        setTimeout(() => {
          fetchStores();
          renderStoreAction();
        }, 2000);
      } catch (error) {
        console.error("Fel vid skapande av butik:", error.message);
        showAlert("Fel vid skapande av butik: " + error.message, "error");
      }
    }

    // Hämta och visa butiker
    function fetchStores() {
      fetch("https://api.webstay.se/get-users")
        .then(res => res.json())
        .then(allStores => {
          const userStores = allStores.filter(store =>
            store.UserID === currentUser.sub && store.StoreID.trim() !== ""
          );
          displayStores(userStores);
        })
        .catch(err => {
          console.error("Fel vid hämtning av butiker:", err);
          showAlert("Fel vid hämtning av butiker.", "error");
        });
    }

    // Rendera butikerna som klickbara kort (hela kortet agerar som en knapp)
    function displayStores(stores) {
      const storeList = document.getElementById("storeList");
      storeList.innerHTML = "";
      if (stores.length === 0) {
        storeList.innerHTML = `<li class="p-4 bg-gray-700 rounded text-center">Inga butiker hittades.</li>`;
      } else {
        stores.forEach(store => {
          const li = document.createElement("li");
          li.className = "p-4 bg-gray-700 rounded shadow hover:shadow-lg transition transform hover:scale-105 cursor-pointer";
          li.onclick = () => {
            window.location.href = `https://dash.webstay.se/store?${store.StoreID}`;
          };
          li.innerHTML = `
            <div class="font-bold text-lg">Butik: ${store.StoreID}</div>
            <div class="mt-2 text-sm">
              <span class="font-medium">Plan:</span> ${store.PlanName || "Ingen plan"}<br>
              <span class="font-medium">Betalning:</span> ${store.PaymentDate || "Ej registrerad"}
            </div>
          `;
          storeList.appendChild(li);
        });
      }
    }
  </script>
</body>
</html>
