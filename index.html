<!DOCTYPE html>
<html lang="sv" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Webstay Dashboard</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Custom Styles & Animations -->
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.5s ease-out;
    }
    .loader {
      border-top: 4px solid #3b82f6;
      border-right: 4px solid transparent;
      border-radius: 50%;
      width: 3rem;
      height: 3rem;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .store-card:hover {
      transform: translateY(-4px) scale(1.03);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }
    .nav-button {
      margin-left: 0.5rem;
      padding: 0.5rem 1rem;
      background-color: #2563eb;
      color: white;
      border-radius: 0.375rem;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }
    .nav-button:hover {
      background-color: #1d4ed8;
      transform: scale(1.03);
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-200">
  <!-- Sidebar -->
  <div class="fixed inset-y-0 left-0 w-64 bg-gray-800 p-6">
    <div class="mb-8">
      <h2 class="text-2xl font-bold text-white">Dashboard</h2>
    </div>
    <nav>
      <ul>
        <li class="mb-4">
          <a href="index.html" class="block py-2 px-4 rounded hover:bg-gray-700 text-white">Dashboard</a>
        </li>
        <li class="mb-4">
          <a href="create.html" class="block py-2 px-4 rounded hover:bg-gray-700 text-white">Skapa Butik</a>
        </li>
        <li class="mb-4" id="expressDashboardNav" style="display: none;">
          <button onclick="openExpressDashboard()" class="w-full text-left py-2 px-4 rounded hover:bg-gray-700 text-white">
            Öppna Express Dashboard
          </button>
        </li>
      </ul>
    </nav>
  </div>

  <!-- Main Content Area -->
  <div class="ml-64 p-6 pt-20">
    <div id="userInfo" class="text-right mb-4 text-sm"></div>
    <h1 class="text-3xl font-bold mb-6">Mina Butiker</h1>
    <ul id="storeList" class="space-y-4"></ul>
  </div>

  <!-- Waiting Overlay -->
  <div id="waitingScreen" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="text-xl font-semibold mb-4">Väntar på inloggning...</div>
    <div class="loader"></div>
  </div>

  <!-- Active Plan Modal -->
  <div id="activePlanModal" class="fixed inset-0 flex items-center justify-center z-50 bg-gray-800 bg-opacity-80 hidden">
    <div class="bg-white p-8 rounded-lg shadow-2xl text-gray-900 text-center animate-fadeIn">
      <p class="text-xl font-semibold">Du har ingen aktiv plan.</p>
      <p class="mt-2">Du loggas ut och omdirigeras...</p>
    </div>
  </div>

  <!-- Custom Alert Container -->
  <div id="alertMessage" class="fixed top-4 right-4 z-50 p-4 rounded-lg hidden"></div>

  <script>
    let currentUser = null;
    let loginPopup = null;

    // Returns the allowed number of stores based on the user's plan.
    function getStoreLimit(plan) {
      switch (plan) {
        case "Start": return 1;
        case "Premium": return 3;
        case "Ultimate": return 10;
        case "Exclusive":
        case "Owner": return Infinity;
        default: return 1;
      }
    }

    // Update the top-right user info.
    function updateUserInfo() {
      document.getElementById("userInfo").innerHTML = `
        Inloggad som: <strong>${currentUser.email}</strong>
        <button onclick="logout()" class="ml-2 px-2 py-1 bg-red-600 text-white rounded hover:bg-red-500 transition">
          Logga ut
        </button>
      `;
      // Show Express Dashboard nav if stripeAccountId exists.
      if (currentUser.stripeAccountId) {
        document.getElementById("expressDashboardNav").style.display = "block";
      } else {
        document.getElementById("expressDashboardNav").style.display = "none";
      }
    }

    // Logout and reload.
    function logout() {
      localStorage.removeItem("authToken");
      localStorage.removeItem("authUser");
      location.reload();
    }

    // Show custom alert.
    function showAlert(message, type = "error") {
      const alertDiv = document.getElementById("alertMessage");
      const bgClass = type === "error" ? "bg-red-600 border-red-800" : "bg-green-600 border-green-800";
      alertDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-lg border ${bgClass} text-white`;
      alertDiv.textContent = message;
      alertDiv.classList.remove("hidden");
      setTimeout(() => alertDiv.classList.add("hidden"), 5000);
    }

    // Show/hide waiting overlay.
    function showWaitingScreen() { document.getElementById("waitingScreen").classList.remove("hidden"); }
    function hideWaitingScreen() { document.getElementById("waitingScreen").classList.add("hidden"); }

    // Show active plan modal.
    function showActivePlanModal() { document.getElementById("activePlanModal").classList.remove("hidden"); }
    function hideActivePlanModal() { document.getElementById("activePlanModal").classList.add("hidden"); }

    // Open the login popup using your /auth page.
    function openLoginPopup() {
      loginPopup = window.open("https://webstay.se/auth", "Login", "width=500,height=600");
      if (!loginPopup) showAlert("Popup-blocker hindrade inloggning. Vänligen tillåt popup-fönster.", "error");
    }

    // Listen for messages from the login popup.
    window.addEventListener("message", function(event) {
      if (event.origin !== "https://webstay.se") return;
      const data = event.data;
      if (data && data.authToken && data.user) {
        localStorage.setItem("authToken", data.authToken);
        localStorage.setItem("authUser", JSON.stringify(data.user));
        currentUser = data.user;
        updateUserInfo();
        if (loginPopup) loginPopup.close();
        hideWaitingScreen();
        checkActivePlan();
      }
    });

    // On page load.
    document.addEventListener("DOMContentLoaded", function() {
      const storedToken = localStorage.getItem("authToken");
      const storedUser = localStorage.getItem("authUser");
      if (storedToken && storedUser) {
        currentUser = JSON.parse(storedUser);
        updateUserInfo();
        checkActivePlan();
      } else {
        showWaitingScreen();
        openLoginPopup();
      }
    });

    // Check if the current user's Google ID exists in the API response.
    // If not, show modal, logout, and redirect after 1 second.
    async function checkActivePlan() {
      try {
        const res = await fetch("https://api.webstay.se/get-users");
        const allRecords = await res.json();
        const activePlanRecords = allRecords.filter(record => record.UserID === currentUser.sub);
        console.log("Active plan records:", activePlanRecords);
        if (activePlanRecords.length === 0) {
          showActivePlanModal();
          setTimeout(() => { logout(); window.location.href = "https://order.webstay.se"; }, 1000);
        } else {
          currentUser.plan = activePlanRecords[0].PlanName || "Start";
          // Filter records with a non-empty StoreID.
          const storesCreated = activePlanRecords.filter(record => record.StoreID && record.StoreID.trim() !== "");
          displayStores(storesCreated);
        }
      } catch (error) {
        console.error("Fel vid kontroll av aktiv plan:", error);
        showAlert("Fel vid kontroll av aktiv plan.", "error");
      }
    }

    // Display stores; if StoreID contains commas, split and display each as separate cards.
    function displayStores(stores) {
      const storeList = document.getElementById("storeList");
      storeList.innerHTML = "";
      if (stores.length === 0) {
        storeList.innerHTML = `<li class="p-4 bg-gray-700 rounded text-center">Inga butiker hittades.</li>`;
      } else {
        stores.forEach(store => {
          let storeIDs = store.StoreID.includes(",") ? store.StoreID.split(",") : [store.StoreID];
          storeIDs.forEach(id => {
            id = id.trim();
            const li = document.createElement("li");
            li.className = "store-card p-4 bg-gray-700 rounded shadow transition-all duration-300 cursor-pointer";
            li.onclick = () => { window.location.href = `https://dash.webstay.se/?${id}`; };
            li.innerHTML = `
              <div class="font-bold text-lg">Butik: ${id}</div>
              <div class="mt-2 text-sm">
                <span class="font-medium">Plan:</span> ${store.PlanName || "Ingen plan"}<br>
                <span class="font-medium">Betalning:</span> ${store.PaymentDate && store.PaymentDate.trim() !== "" ? "Aktiv" : "Ej registrerad"}
              </div>
            `;
            storeList.appendChild(li);
          });
        });
      }
    }

    // Open Express Dashboard: calls the backend endpoint to get a login link, then opens it in a popup.
    async function openExpressDashboard() {
      if (!currentUser.stripeAccountId) {
        // Do not show an error; you can optionally show a friendly message.
        showAlert("Inget Stripe-konto kopplat till ditt konto.", "error");
        return;
      }
      try {
        const res = await fetch(`/api/express-dashboard-login?accountId=${currentUser.stripeAccountId}`);
        if (!res.ok) throw new Error("Kunde inte skapa login-länk.");
        const data = await res.json();
        if (data.url) {
          window.open(data.url, "ExpressDashboard", "width=600,height=800,scrollbars=yes,resizable=yes");
        } else {
          throw new Error("Inget URL mottaget.");
        }
      } catch (error) {
        console.error("Fel vid öppnande av Express Dashboard:", error);
        showAlert("Fel vid öppnande av Express Dashboard.", "error");
      }
    }
  </script>
</body>
</html>
